name: CI - Development Branch

on:
  push:
    branches:
    - main

  pull_request:
    branches:
    - main

jobs:
  lint:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check formatting with clang-format
      id: lint-check
      run: |
        set +e
        cmake -D FORMAT_COMMAND=clang-format-18 -P cmake/lint.cmake
        rc=$?
        echo "lint_exit_code=$rc" >> "$GITHUB_OUTPUT"
        exit 0

    - name: Auto-fix formatting with clang-format
      if: steps.lint-check.outputs.lint_exit_code != '0'
      run: |
        cmake -D FORMAT_COMMAND=clang-format-18 -D FIX=YES -P cmake/lint.cmake

    - name: Commit and push formatting changes
      if: steps.lint-check.outputs.lint_exit_code != '0' && github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if git diff --quiet; then
          echo "No formatting changes to commit."
          exit 0
        fi
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "chore(style): auto-format with clang-format-18"
        git push || echo "Push failed, continuing without failing lint job."

  build-and-test:
    needs: [lint]
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install latest CMake and Ninja
      uses: lukka/get-cmake@latest

    - name: Install Clang 18 with C++23 support
      run: |
        sudo apt-get update -q
        sudo apt-get install -y -q clang-18 libc++-18-dev libc++abi-18-dev ccache
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: 'd7112d1a4fb50410d3639f5f586972591d848beb'

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ runner.os }}

    - name: Verify C++ compiler version
      run: clang++ --version

    - name: Run CMake with preset (configure, build, and test)
      uses: lukka/run-cmake@v10
      with:
        configurePreset: 'tests'
        buildPreset: 'tests-build'
        testPreset: 'dev-test'
      env:
        CC: clang-18
        CXX: clang++-18
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache

  coverage:
    needs: [lint]
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install latest CMake and Ninja
      uses: lukka/get-cmake@latest

    - name: Install dependencies
      run: |
        sudo apt-get update -q
        sudo apt-get install -y -q clang-18 llvm-18 libc++-18-dev libc++abi-18-dev lcov ccache
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
        sudo update-alternatives --install /usr/bin/llvm-cov llvm-cov /usr/bin/llvm-cov-18 100

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: 'd7112d1a4fb50410d3639f5f586972591d848beb'

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ runner.os }}

    - name: Verify C++ compiler version
      run: clang++ --version

    - name: Run CMake with preset (configure and build)
      uses: lukka/run-cmake@v10
      with:
        configurePreset: 'tests'
        buildPreset: 'tests-build'
      env:
        CC: clang-18
        CXX: clang++-18
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache

    - name: Generate coverage report
      run: cmake --build build/tests --target coverage

    - name: Upload coverage to codecov
      uses: codecov/codecov-action@v4
      with:
        file: build/tests/coverage.info
        token: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true

