name: CI - Production Branch

on:
  push:
    branches:
    - dev

  pull_request:
    branches:
    - dev

jobs:
  lint:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check formatting with clang-format
      id: lint-check
      run: |
        set +e
        cmake -D FORMAT_COMMAND=clang-format-18 -P cmake/lint.cmake
        rc=$?
        echo "lint_exit_code=$rc" >> "$GITHUB_OUTPUT"
        exit 0

    - name: Auto-fix formatting with clang-format
      if: steps.lint-check.outputs.lint_exit_code != '0'
      run: |
        cmake -D FORMAT_COMMAND=clang-format-18 -D FIX=YES -P cmake/lint.cmake

    - name: Commit and push formatting changes
      if: steps.lint-check.outputs.lint_exit_code != '0' && github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if git diff --quiet; then
          echo "No formatting changes to commit."
          exit 0
        fi
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "chore(style): auto-format with clang-format-18"
        git push || echo "Push failed, continuing without failing lint job."

  build-and-test:
    needs: [lint]
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Install Clang 18 with C++23 support
      run: |
        sudo apt-get update -q
        sudo apt-get install -y -q clang-18 libc++-18-dev libc++abi-18-dev ccache
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ matrix.os }}

    - name: Verify C++ compiler version
      run: clang++ --version

    - name: Cache CMake build directory
      uses: actions/cache@v4
      with:
        path: |
          build/tests
          !build/tests/coverage.info
        key: ${{ runner.os }}-cmake-tests-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-tests-

    - name: Cache FetchContent dependencies
      uses: actions/cache@v4
      with:
        path: build/tests/_deps
        key: ${{ runner.os }}-fetchcontent-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-fetchcontent-

    - name: Configure tests
      run: CC=clang-18 CXX=clang++-18 cmake --preset=tests
      env:
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache

    - name: Build tests
      run: cmake --build build/tests --preset=tests-build -j 2

    - name: Run tests
      run: ctest --preset=dev-test

  coverage:
    needs: [lint]
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update -q
        sudo apt-get install -y -q clang-18 llvm-18 libc++-18-dev libc++abi-18-dev lcov ccache
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
        sudo update-alternatives --install /usr/bin/llvm-cov llvm-cov /usr/bin/llvm-cov-18 100

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ matrix.os }}

    - name: Verify C++ compiler version
      run: clang++ --version

    - name: Cache FetchContent dependencies
      uses: actions/cache@v4
      with:
        path: build/tests/_deps
        key: ${{ runner.os }}-fetchcontent-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-fetchcontent-

    - name: Configure tests
      run: CC=clang-18 CXX=clang++-18 cmake --preset=tests
      env:
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache

    - name: Build tests
      run: cmake --build build/tests --preset=tests-build -j 2

    - name: Generate coverage report
      run: cmake --build build/tests --target coverage

    - name: Upload coverage to codecov
      uses: codecov/codecov-action@v4
      with:
        file: build/tests/coverage.info
        token: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true

  docs:
    needs: [build-and-test]
    runs-on: ubuntu-24.04

    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Clang 18 and Doxygen
      run: |
        sudo apt-get update -q
        sudo apt-get install -y -q clang-18 libc++-18-dev libc++abi-18-dev doxygen ccache
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-${{ matrix.os }}

    - name: Cache CMake build directory
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ runner.os }}-cmake-docs-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-docs-

    - name: Cache FetchContent dependencies
      uses: actions/cache@v4
      with:
        path: build/_deps
        key: ${{ runner.os }}-fetchcontent-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-fetchcontent-

    - name: Configure
      run: CC=clang-18 CXX=clang++-18 cmake --preset=docs
      env:
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache

    - name: Build docs
      run: cmake --build build --target docs

    - name: Deploy docs to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: build/docs/html
      continue-on-error: true


