name: CI - Production

on:
  push:
    branches:
    - main
    - github-actions*

  pull_request:
    branches:
    - main
    - github-actions*

jobs:
  ci:
    uses: ./.github/workflows/reusable-ci.yml
    secrets: inherit
    with:
      auto-format: false
      run-windows: true

  docs:
    needs: [ci]
    runs-on: ubuntu-24.04
    if: github.event_name == 'push'

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install latest CMake and Ninja
      uses: lukka/get-cmake@latest

    - name: Cache apt packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: clang-18 libc++-18-dev libc++abi-18-dev doxygen ccache libx11-dev libxrandr-dev libxcursor-dev libxi-dev libudev-dev libgl1-mesa-dev
        version: 1.0

    - name: Setup compiler alternatives
      run: |
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: 'ae8fa5ae5e6162a88e412618245809ed2aa579d9'

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: docs-${{ runner.os }}-${{ github.ref_name }}
        restore-keys: |
          docs-${{ runner.os }}-

    - name: Configure and build docs
      uses: lukka/run-cmake@v10
      with:
        configurePreset: 'docs'
      env:
        CC: clang-18
        CXX: clang++-18
        CMAKE_C_COMPILER_LAUNCHER: ccache
        CMAKE_CXX_COMPILER_LAUNCHER: ccache

    - name: Generate documentation
      run: |
        cmake --build build/docs --preset=docs-build
        cmake --build build/docs --target docs-run

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/html
      continue-on-error: true

  mirror:
    needs: [ci]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Push to Epitech mirror
      uses: pixta-dev/repository-mirroring-action@v1
      with:
        target_repo_url: "git@github.com:EpitechPGE3-2025/G-CPP-500-PAR-5-2-rtype-5.git"
        ssh_private_key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}
